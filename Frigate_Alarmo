blueprint:
  name: "Frigate: Envoyer la vidéo lors d'une alarme Alarmo"
  description: "Envoie une vidéo de Frigate lorsqu'une alarme est déclenchée par Alarmo."
  domain: automation
  input:
    alarmo_event:
      name: "Événement de déclenchement Alarmo"
      description: "Sélectionner l'entité d'alarme qui déclenche l'automatisation"
      selector:
        entity:
          domain: alarm_control_panel

    frigate_camera:
      name: "Caméra Frigate"
      description: "Sélectionner la caméra de Frigate pour laquelle l'automatisation enverra la vidéo"
      selector:
        entity:
          integration: frigate

    notification_title:
      name: "Titre de la notification"
      description: "Titre de la notification envoyée"
      default: "Alerte de sécurité déclenchée!"
      selector:
        text:

    notification_message:
      name: "Message de la notification"
      description: "Message à inclure dans la notification"
      default: "Une alarme a été déclenchée. Voir la vidéo ci-jointe."
      selector:
        text:

    notify_service:
      name: "Service de notification"
      description: "Service utilisé pour envoyer la notification (e.g., mobile_app, notify)"
      selector:
        entity:
          domain: notify

trigger:
  - platform: state
    entity_id: !input alarmo_event
    to: "triggered"

action:
  - service: frigate.clip
    data:
      camera: !input frigate_camera
      label: person
      duration: 30  # Durée du clip en secondes, ajustable

  - delay: "00:00:10"  # Attendre que le clip soit généré (ajuster si nécessaire)

  - service: !input notify_service
    data:
      title: !input notification_title
      message: !input notification_message
      data:
        video:
          url: >
            "{{ state_attr('camera.{{ input.frigate_camera }}', 'last_clip_url') }}"

mode: single
